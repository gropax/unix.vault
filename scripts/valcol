#!/usr/bin/env bash
set -euo pipefail

if [ $# -lt 1 ]; then
    echo "Error: missing collection name."
    echo "Usage: $0 <collection>"
    exit 1
fi

: "${VAULT_DIR:="$(cd "$(dirname "$0")" && pwd)/.."}"

COLL_DIR="$VAULT_DIR/collections/$1"
SCHEMA_FILE="$COLL_DIR/schema.toml"
DATA_FILES="$COLL_DIR/data/*.yaml"

if [ ! -d "$COLL_DIR" ]; then
    echo "Error: collection does not exist: $COLL_DIR"
    exit 1
fi

if [ ! -f "$SCHEMA_FILE" ]; then
    echo "Error: schema not found: $SCHEMA_FILE"
    exit 1
fi

conform "$SCHEMA_FILE" "$DATA_FILES" | vi -q -
