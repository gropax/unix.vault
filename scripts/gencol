#!/usr/bin/env bash
set -euo pipefail

if [ $# -lt 1 ]; then
    echo "Error: missing collection name."
    echo "Usage: $0 <collection>"
    exit 1
fi

: "${ROOT_DIR:="$(cd "$(dirname "$0")" && pwd)/.."}"

VAULT_DIR="$ROOT_DIR/build/obsidian/Unix"
COLL_DIR="$ROOT_DIR/collections/$1"
TEMPLATE_FILE="$COLL_DIR/template.md"
DATA_DIR="$COLL_DIR/data"
PAGES_DIR="$VAULT_DIR/$1/pages"

echo "$PAGES_DIR"

if [ ! -d "$COLL_DIR" ]; then
    echo "Error: collection does not exist: $COLL_DIR"
    exit 1
fi

if [ ! -f "$TEMPLATE_FILE" ]; then
    echo "Warning: template not found: $TEMPLATE_FILE"
    TEMPLATE=""
else
    TEMPLATE="$(<"$TEMPLATE_FILE")"
fi

shopt -s nullglob
DATA_FILES=("$DATA_DIR"/*.yaml)
if [ ${#DATA_FILES[@]} -eq 0 ]; then
    echo "Warning: no .yaml data files in $DATA_DIR"
fi

mkdir -p "$PAGES_DIR"

for f in "${DATA_FILES[@]}"; do
    FILE_NAME=$(basename "$f")
    YAML="$(<"$f")"
    PAGE_FILE="$PAGES_DIR/${FILE_NAME%.yaml}.md"

    printf -- '---\n%s\n---\n%s' "$YAML" "$TEMPLATE" > "$PAGE_FILE"

    echo "Generated: $PAGE_FILE"
done
